<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상세보기</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* [기본 폰트 및 배경] */
        body { 
            font-family: 'Pretendard', sans-serif; 
            background: #f0f2f5; 
            margin: 0;
            padding-top: 100px; /* 헤더 공간 확보 */
            padding-bottom: 50px;
        }

        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 40px; 
            border-radius: 15px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }
        
        /* [★수정됨] 미디어 영역 (기본 틀) */
        .view-media { 
            width: 100%; 
            margin-bottom: 30px; 
            border-radius: 10px; 
            overflow: hidden; 
            background: #000; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            /* 최소 높이 제거 (내용물에 맞춤) */
        }
        
        /* 이미지와 일반 동영상은 너비 100%로 맞춤 */
        .view-media img, .view-media video { 
            width: 100%; 
            height: auto; 
            max-height: 600px; 
            object-fit: contain; 
        }

        /* [★추가됨] 유튜브용 반응형 컨테이너 (16:9 비율 고정) */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 비율 유지 (9 / 16 = 0.5625) */
            height: 0;
            overflow: hidden;
        }
        
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .view-title { font-size: 1.8rem; font-weight: 800; margin-bottom: 15px; color: #1a3c6e; }
        .view-meta { color: #888; border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 30px; font-size: 0.95rem; }
        .view-content { font-size: 1.1rem; line-height: 1.8; white-space: pre-wrap; color: #444; min-height: 100px; }
        
        /* 버튼 스타일 */
        .btn-group { margin-top: 40px; display: flex; justify-content: space-between; align-items: center; }
        .btn-list { background: #666; color: white; padding: 12px 25px; text-decoration: none; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        .btn-list:hover { background: #555; }

        .btn-right { display: flex; gap: 10px; }
        .btn-edit { background: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; text-decoration: none; font-size: 1rem; transition: 0.3s; }
        .btn-edit:hover { background: #218838; }
        .btn-delete { background: #e76f51; color: white; padding: 12px 20px; border:none; border-radius: 5px; cursor:pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; }
        .btn-delete:hover { background: #c0392b; }
        
        footer { background: #222; color: #888; padding: 40px 0; text-align: center; margin-top: 50px; }

        /* 모바일 여백 조정 */
        @media (max-width: 768px) {
            .container { padding: 20px; }
            .view-title { font-size: 1.4rem; }
        }
    </style>
</head>
<body>

    <header></header>

    <div class="container">
        <div class="view-media" id="media-area">
            <span style="color:white; padding: 50px;">로딩 중...</span>
        </div>

        <div class="view-title" id="v-title">제목 로딩 중...</div>
        <div class="view-meta" id="v-meta">정보 로딩 중...</div>
        <div class="view-content" id="v-content"></div>

        <div class="btn-group">
            <a href="culture.html" class="btn-list">목록으로</a>
            <div class="btn-right">
                <a href="javascript:void(0)" onclick="goEdit()" class="btn-edit">수정하기</a>
                <button class="btn-delete" onclick="deletePost()">삭제하기</button>
            </div>
        </div>
    </div>

    <footer></footer>
    <script src="manager.js"></script>

    <script>
        const SUPABASE_URL = "https://chmpykdpiwmotmfenirr.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNobXB5a2RwaXdtb3RtZmVuaXJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MTQ0NDksImV4cCI6MjA4MzA5MDQ0OX0.vL8_JBLEWXgrvjtfcoZ5BeqFiIRhFKrItx47VzDdmjQ";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');

        function getYoutubeId(url) {
            if (!url) return null;
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            if (match && match[7].length === 11) return match[7];
            if (url.includes('/shorts/')) return url.split('/shorts/')[1].split('?')[0];
            return null;
        }

        async function loadPost() {
            if (!id) { alert("잘못된 접근입니다."); location.href = 'culture.html'; return; }

            try {
                const { data, error } = await sb.from('gallery').select('*').eq('id', id).single();
                if (error) throw error;

                document.getElementById('v-title').innerText = data.title;
                const date = data.created_at ? data.created_at.split('T')[0] : "";
                document.getElementById('v-meta').innerText = `작성자: ${data.writer} | 작성일: ${date}`;
                document.getElementById('v-content').innerText = data.content;

                const fileUrl = data.file_url || "";
                const mediaArea = document.getElementById('media-area');
                const youtubeId = getYoutubeId(fileUrl);
                
                // [CASE 1] 유튜브 링크 (반응형 적용)
                if (youtubeId) {
                    const origin = window.location.origin;
                    
                    if (origin.includes('file://')) {
                         mediaArea.innerHTML = `
                            <div style="color:white; text-align:center; padding:20px;">
                                <h3 style="color:red;">⚠️ 컴퓨터 파일(file://) 상태에서는 재생불가!</h3>
                                <p>GitHub에 올린 뒤 인터넷 주소로 접속하세요.</p>
                            </div>`;
                    } else {
                        // ★ 반응형 div(video-container)로 감싸기 ★
                        mediaArea.innerHTML = `
                            <div class="video-container">
                                <iframe 
                                    src="https://www.youtube.com/embed/${youtubeId}?autoplay=1&mute=1&playsinline=1&origin=${origin}" 
                                    title="YouTube video player" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                    referrerpolicy="strict-origin-when-cross-origin"
                                    allowfullscreen>
                                </iframe>
                            </div>`;
                    }
                } 
                // [CASE 2] 직접 올린 파일
                else if (fileUrl.includes('.mp4') || fileUrl.includes('.mov')) {
                    mediaArea.innerHTML = `<video src="${fileUrl}" controls autoplay muted playsinline></video>`;
                } 
                // [CASE 3] 이미지
                else if (fileUrl) {
                    mediaArea.innerHTML = `<img src="${fileUrl}" alt="상세 이미지">`;
                }
                else {
                    mediaArea.innerHTML = `<span style="color:#aaa;">이미지가 없는 게시물입니다.</span>`;
                }

            } catch (err) {
                alert("오류: " + err.message);
            }
        }

        function goEdit() { location.href = `gallery_write.html?id=${id}`; }
        async function deletePost() {
            if(confirm("정말 삭제하시겠습니까?")) {
                await sb.from('gallery').delete().eq('id', id);
                location.href = 'culture.html';
            }
        }

        loadPost();
    </script>
</body>
</html>
